otus_ZFS
–ê–≤—Ç–æ—Ä: Kamil Ibragimov

## –î–æ–º–∞—à–Ω–µ–µ –∑–∞–¥–∞–Ω–∏–µ: —Ä–∞–±–æ—Ç–∞ —Å ZFS
–ó–∞–¥–∞–Ω–∏–µ:   
1. –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å –∞–ª–≥–æ—Ä–∏—Ç–º —Å –Ω–∞–∏–ª—É—á—à–∏–º —Å–∂–∞—Ç–∏–µ–º:   
‚Ä¢ –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å –∫–∞–∫–∏–µ –∞–ª–≥–æ—Ä–∏—Ç–º—ã —Å–∂–∞—Ç–∏—è –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç zfs (gzip, zle, lzjb, lz4);   
‚Ä¢ C–æ–∑–¥–∞—Ç—å 4 —Ñ–∞–π–ª–æ–≤—ã—Ö —Å–∏—Å—Ç–µ–º—ã –Ω–∞ –∫–∞–∂–¥–æ–π –ø—Ä–∏–º–µ–Ω–∏—Ç—å —Å–≤–æ–π –∞–ª–≥–æ—Ä–∏—Ç–º —Å–∂–∞—Ç–∏—è;   
‚Ä¢ –î–ª—è —Å–∂–∞—Ç–∏—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ª–∏–±–æ —Ç–µ–∫—Å—Ç–æ–≤—ã–π —Ñ–∞–π–ª, –ª–∏–±–æ –≥—Ä—É–ø–ø—É —Ñ–∞–π–ª–æ–≤.   
2. –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—É–ª–∞ –∏ –ø—Ä–∏ –ø–æ–º–æ—â–∏ –∫–æ–º–∞–Ω–¥—ã zfs import —Å–æ–±—Ä–∞—Ç—å pool ZFS.   
–ö–æ–º–∞–Ω–¥–∞–º–∏ zfs –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏:     
‚Ä¢ –†–∞–∑–º–µ—Ä —Ö—Ä–∞–Ω–∏–ª–∏—â–∞;   
‚Ä¢ –¢–∏–ø pool;   
‚Ä¢ –ó–Ω–∞—á–µ–Ω–∏–µ recordsize;   
‚Ä¢ –ö–∞–∫–æ–µ —Å–∂–∞—Ç–∏–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è;   
‚Ä¢ –ö–∞–∫–∞—è –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω–∞—è —Å—É–º–º–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è.   
3. –†–∞–±–æ—Ç–∞ —Å–æ —Å–Ω–∞–ø—à–æ—Ç–∞–º–∏:   
‚Ä¢ –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Ñ–∞–π–ª –∏–∑ —É–¥–∞–ª–µ–Ω–Ω–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏;   
‚Ä¢ –°–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ñ–∞–π–ª –ª–æ–∫–∞–ª—å–Ω–æ. zfs receive;   
‚Ä¢ –ù–∞–π—Ç–∏ –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ —Ñ–∞–π–ª–µ secret_message.   

–†–µ–∑—É–ª—å—Ç–∞—Ç:   
‚Ä¢ –°–æ–∑–¥–∞–ª 4 —Ñ–∞–π–ª–æ–≤—ã–µ —Å–∏—Å—Ç–µ–º—ã —Å —Ä–∞–∑–Ω—ã–º–∏ –∞–ª–≥–æ—Ä–∏—Ç–º–∞–º–∏ —Å–∂–∞—Ç–∏—è –∏ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–ª –ª–æ–≥ —Ñ–∞–π–ª—ã. –†–µ–∑—É–ª—å—Ç–∞—Ç —Å–º. –Ω–∞ —Å–∫—Ä–∏–Ω—à–æ—Ç–µ üñºÔ∏è ["gzip"](https://github.com/kamil1403/otus_ZFS/blob/main/screenshots/gzip_zfs.png)  
‚Ä¢ –ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–ª –ø—É–ª –∏ –ø–æ—Å–º–æ—Ç—Ä–µ–ª –µ–≥–æ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏. –†–µ–∑—É–ª—å—Ç–∞—Ç —Å–º. –Ω–∞ —Å–∫—Ä–∏–Ω—à–æ—Ç–µ üñºÔ∏è ["pool"](https://github.com/kamil1403/otus_ZFS/blob/main/screenshots/pool_zfs.png)  
‚Ä¢ –°–æ–∑–¥–∞–ª —Å–Ω–∞–ø—à–æ—Ç –∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏–ª —Ñ–∞–π–ª—ã –∏–∑ –Ω–µ–≥–æ. –†–µ–∑—É–ª—å—Ç–∞—Ç —Å–º. –Ω–∞ —Å–∫—Ä–∏–Ω—à–æ—Ç–µ üñºÔ∏è ["snapshot"](https://github.com/kamil1403/otus_ZFS/blob/main/screenshots/snapshot_zfs.png) 


## üß≠ –û–≥–ª–∞–≤–ª–µ–Ω–∏–µ üñºÔ∏è

- [üì¶ –ê–ª–≥–æ—Ä–∏—Ç–º—ã —Å–∂–∞—Ç–∏—è](#gzip)
- [‚öôÔ∏è –ò–º–ø–æ—Ä—Ç –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—É–ª–∞](#pool)
- [üì∏ –†–∞–±–æ—Ç–∞ —Å–æ —Å–Ω–∞–ø—à–æ—Ç–∞–º–∏](#snapshot)
- [üí° –†–∞–∑–ª–∏—á–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã –∏–∑ —É—Ä–æ–∫–∞](#other)

---

<a id="gzip"></a>
## üì¶ –ê–ª–≥–æ—Ä–∏—Ç–º—ã —Å–∂–∞—Ç–∏—è

```bash
# –°–æ–∑–¥–∞–µ—Ç –Ω–æ–≤—ã–π –ø—É–ª   
zpool create otus_pool /dev/sdb /dev/sdc   
# –°–æ–∑–¥–∞–µ—Ç —á–µ—Ç—ã—Ä–µ —Ñ–∞–π–ª–æ–≤—ã–µ —Å–∏—Å—Ç–µ–º—ã   
zfs create otus_pool/gzip_test_zfs   
zfs create otus_pool/lz4_test_zfs   
zfs create otus_pool/lzjb_test_zfs   
zfs create otus_pool/zle_test_zfs   
# –ü—Ä–∏–º–µ–Ω—è–µ—Ç —Å–∂–∞—Ç–∏–µ   
zfs set compression=gzip otus_pool/gzip_test_zfs   
zfs set compression=lz4 otus_pool/lz4_test_zfs   
zfs set compression=lzjb otus_pool/lzjb_test_zfs   
zfs set compression=zle otus_pool/zle_test_zfs   
# –ö–æ–ø–∏—Ä—É–µ—Ç –¥–ª—è —Ç–µ—Å—Ç–∞ —Ñ–∞–π–ª—ã –ª–æ–≥–æ–≤   
cp -r /var/log/* /otus_pool/gzip_test_zfs   
cp -r /var/log/* /otus_pool/lz4_test_zfs   
cp -r /var/log/* /otus_pool/lzjb_test_zfs   
cp -r /var/log/* /otus_pool/zle_test_zfs   
# –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å—Ç–µ–ø–µ—Ä—å —Å–∂–∞—Ç–∏—è —Ñ–∞–π–ª–æ–≤ –≤ –∫–∞–∂–¥–æ–º –∫–∞—Ç–∞–ª–æ–≥–µ   
zfs get compressratio otus_pool  
zfs get compressratio otus_pool/gzip_test_zfs   
zfs get compressratio otus_pool/lz4_test_zfs   
zfs get compressratio otus_pool/lzjb_test_zfs   
zfs get compressratio otus_pool/zle_test_zfs 
```

---

<a id="pool"></a>
## ‚öôÔ∏è –ò–º–ø–æ—Ä—Ç –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—É–ª–∞

```bash|
# –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø—É–ª—ã, –¥–æ—Å—Ç—É–ø–Ω—ã–µ –¥–ª—è –∏–º–ø–æ—Ä—Ç–∞  
zpool import
# –ü–æ–¥–∫–ª—é—á–∞–µ—Ç –ø—É–ª
zpool import otus_pool
# –†–∞–∑–º–µ—Ä –ø—É–ª–∞
zpool list otus_pool
# –¢–∏–ø –ø—É–ª–∞
zpool status otus_pool
# –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å—Ç–µ–ø–µ—Ä—å —Å–∂–∞—Ç–∏—è —Ñ–∞–π–ª–æ–≤ –≤ –∫–∞–∂–¥–æ–º –∫–∞—Ç–∞–ª–æ–≥–µ   
zfs get compressratio otus_pool  
zfs get compressratio otus_pool/gzip_test_zfs   
zfs get compressratio otus_pool/lz4_test_zfs   
zfs get compressratio otus_pool/lzjb_test_zfs   
zfs get compressratio otus_pool/zle_test_zfs 
#–ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω—ã–µ —Å—É–º–º—ã –ø—É–ª–∞
zfs get checksum otus_pool
# –ü–æ–∫–∞–∑—ã–∞–µ—Ç –≤—Å–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—É–ª–∞
zfs get all otus_pool 
```

---

<a id="snapshot"></a>
## üì∏ –†–∞–±–æ—Ç–∞ —Å–æ —Å–Ω–∞–ø—à–æ—Ç–∞–º–∏

```bash
#–°–æ–∑–¥–∞–µ—Ç —Å–Ω–∞–ø—à–æ—Ç
zfs snapshot otus_pool/gzip_test_zfs@backup1
# –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç —Å–Ω–∞–ø—à–æ—Ç –≤ —Ñ–∞–π–ª
zfs send otus_pool/gzip_test_zfs@backup1 > /tmp/backup1.zfs
# –£–¥–∞–ª—è–µ—Ç –≤—Å–µ —Ñ–∞–π–ª—ã –∏–∑ –∫–∞—Ç–∞–ª–æ–≥–∞
rm -rf /otus_pool/gzip_test_zfs/*
#–ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç —Å–Ω–∞–ø—à–æ—Ç
zfs receive otus_pool/restored_backup < /tmp/backup1.zfs
zfs receive -F otus_pool/gzip_test_zfs < /tmp/backup1.zfs
# –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Å–Ω–∞–ø—à–æ—Ç—ã
zfs list -t snapshot
```

---

<a id="other"></a>
## üí° –†–∞–∑–ª–∏—á–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã –∏–∑ —É—Ä–æ–∫–∞

```bash
# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ zpool   
sudo apt install zfsutils-linux   
# –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö ZFS-–ø—É–ª–æ–≤, –∏—Ö —Ä–∞–∑–º–µ—Ä, –¥–æ—Å—Ç—É–ø–Ω–æ–µ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ, —Å–æ—Å—Ç–æ—è–Ω–∏–µ   
zpool list   
# –°–æ–∑–¥–∞–µ—Ç –Ω–æ–≤—ã–π –ø—É–ª —Ä–µ–∂–∏–º–µ mirror (RAID1 - –¥–∞–Ω–Ω—ã–µ –¥—É–±–ª–∏—Ä—É—é—Ç—Å—è –Ω–∞ –æ–±–∞ –¥–∏—Å–∫–∞) –∏–∑ –¥–∏—Å–∫–æ–≤ /dev/vdb –∏ /dev/vdd   
zpool create tmp_pool mirror /dev/vdb /dev/vdd -f   
# –î–µ—Ç–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ –ø—É–ª–∞: —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞, –æ—à–∏–±–∫–∏, –¥–µ–≥—Ä–∞–¥–∞—Ü–∏—è   
zpool status   
# –û—Ç–∫—Ä—ã–≤–∞–µ—Ç manual –ø–æ –∫–æ–º–∞–Ω–¥–µ zpool. /—Å–ª–æ–≤–æ –∏ —Å—Ç—Ä–µ–ª–∫–∞–º–∏ –∏—Å–∫–∞—Ç—å –≤–ø—Ä–µ—Ä–µ–¥ –∏–ª–∏ –Ω–∞–∑–∞–¥. –¢–∞–∫–∂–µ –º–æ–∂–Ω–æ –ª–∏—Å–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∫–ª–∞–≤–∏—à–µ–π N. –ö–ª–∞–≤–∏—à–∫–∞ q - –≤—ã—Ö–æ–¥   
man zpool   
# –°–æ–∑–¥–∞–µ—Ç ZFS —Ñ–∞–π–ª–æ–≤—ã–µ —Å–∏—Å—Ç–µ–º—ã   
zfs create tmp_pool/zfs01   
zfs create tmp_pool/zfs02   
zfs create tmp_pool/zfs03   
# –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –≤—Å–µ —Ñ–∞–π–ª–æ–≤—ã–µ —Å–∏—Å—Ç–µ–º—ã ZFS —Å –∏—Ö —Ä–∞–∑–º–µ—Ä–æ–º, –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –∏ —Å—Ç–∞—Ç—É—Å–æ–º   
zfs list   
# –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å—Ç–∞—Ç—É—Å –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏–∏ (—É–¥–∞–ª–µ–Ω–∏–µ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ –±–ª–æ–∫–æ–≤ –¥–∞–Ω–Ω—ã—Ö)   
zfs get dedup   
# –í–∫–ª—é—á–∞–µ—Ç –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—é –Ω–∞ —Ñ–∞–π–ª–æ–≤–æ–π —Å–∏—Å—Ç–µ–º–µ zfs02   
zfs set dedup=on tmp_pool/zfs02   
# –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –≤—Å–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã ZFS —Å –≤—ã–≤–æ–¥–æ–º –æ—à–∏–±–æ–∫ –≤ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –ø–æ—Ç–æ–∫   
zfs get all 2>&1 | less   
# –°–æ–∑–¥–∞–µ—Ç –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –¥–ª—è —Ç–µ—Å—Ç–∞   
mkdir /tmp_pool/zfs02/test01   
mkdir /tmp_pool/zfs02/test02   
# –ö–æ–ø–∏—Ä—É–µ—Ç –ª–æ–≥–∏ –¥–ª—è —Ç–µ—Å—Ç–∞   
cp -r /var/log/* tmp_pool/zfs01   
cp -r /var/log/* tmp_pool/zfs02   
# –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ç–µ–∫—É—â–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —Å–∂–∞—Ç–∏—è   
zfs get compression   
zfs get compressratio   
# –í–∫–ª—é—á–∞–µ—Ç/–≤—ã–∫–ª—é—á–∞–µ—Ç —Å–∂–∞—Ç–∏–µ –Ω–∞ zfs03   
zfs set compression=on tmp_pool/zfs03   
zfs set compression=off tmp_pool/zfs03   
# –£–¥–∞–ª—è–µ—Ç —Ñ–∞–π–ª–æ–≤—É—é —Å–∏—Å—Ç–µ–º—É zfs03 –∏ –µ—ë —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ (–µ—Å–ª–∏ –ø—Ä–∏–º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–æ)   
rm -rf /tmp_pool/zfs03*   
# –£–¥–∞–ª—è–µ—Ç —Ñ–∞–π–ª–æ–≤—É—é —Å–∏—Å—Ç–µ–º—É zfs01   
zfs destroy tmp_pool/zfs01   
# –£–¥–∞–ª—è–µ—Ç –ø—É–ª
sudo zfs destroy -r tmp_pool
sudo zpool -f destroy tmp_pool
# –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –∫–≤–æ—Ç—ã –Ω–∞ —Ñ–∞–π–ª–æ–≤—ã–µ —Å–∏—Å—Ç–µ–º—ã   
zfs get quota   
# –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ—Ç –æ–±—ä—ë–º —Ñ–∞–π–ª–æ–≤–æ–π —Å–∏—Å—Ç–µ–º—ã zfs01 –¥–æ 10 –º–µ–≥–∞–±–∞–π—Ç
zfs set quota=10M tmp_pool/zfs01
# –û—Ç–∫–ª—é—á–∞–µ—Ç –ø—É–ª
zpool export otus_pool
```

---


